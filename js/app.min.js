sv=function(n,t){var bt="1.4.2.6",cr=5,lr=12,vt=994201,ar=9e3,yi="LETSOS OVERHEAD",ti={Typed:{Height:90},Draw:{Width:460,Height:195}},c={DFT:"ls-sts-dft",SUCCESS:"ls-sts-success",WARN:"ls-sts-warn",FAIL:"ls-sts-invalid"},ht={Raw:0,Uplded:1},d={Exp:{Id:0,Name:"Exp",Desc:"Expense",GrpNo:0},Equip:{Id:1,Name:"Equip",Desc:"Equipment Photo",GrpNo:2},Job:{Id:2,Name:"Job",Desc:"Job Photo",GrpNo:1},Safety:{Id:3,Name:"Safety",Desc:"Safety Photo",GrpNo:1},TaskSht:{Id:4,Name:"TaskSheet",Desc:"Inspection Report",GrpNo:2}},it=function(n){return Math.round((n||0)*100)/100},u={dn:function(n){return parseInt(kendo.toString(n,"yyyyMMdd"))||0},nd:function(n){return kendo.parseDate(n.toString(),"yyyyMMdd")},dt:function(n){return parseInt(kendo.toString(n,"yyyyMMddHHmmss"))||0},td:function(n){return kendo.parseDate(n.toString(),"yyyyMMddHHmmss")},nnow:function(n){return u.dt(n||new Date)},today:function(){var n=new Date;return n.setHours(0,0,0,0),n},weekdayName:function(n){if(!n)return"";var t=n.getDay();return'<span{0} class="ls-dim">{1}<\/span>'.formatWith(t>=1&&t<=5?"":' class="ls-alert"',["Sun","Mon","Tue","Wed","Thu","Fri","Sat"][t])},dui:function(n,t){return kendo.toString(kendo.parseDate(n),t||"d")},dui2:function(n){return n?u.dui(n)+" "+u.weekdayName(n):""},addDays:function(n,t){var i=t?new Date(t):new Date;return i.setDate(i.getDate()+n),i},addHrs:function(n,t){var i=t?new Date(t):new Date;return i.setHours(i.getHours()+n),i},nAdd:function(n,t){var i=t?u.td(t):new Date;return i.setSeconds(i.getSeconds()+(n||1)),u.dt(i)},pd:function(){var t=new Date,n=new Date(t),i,r,f,e,o;return n.setDate(n.getDate()-(n.getDay()==0?7:n.getDay())+1),n.setHours(0,0,0,0),i=u.addDays(7,n),i.setSeconds(i.getSeconds()-1),r=u.addDays(-7,n),f=u.addDays(7,r),f.setSeconds(f.getSeconds()-1),e=ot.editDeadline,e||(e=u.addHrs(cr,n)),o=u.addHrs(lr,n),{uiFrom:t>o?n:r,uiTo:t>o?i:f,validFrom:t>e?n:r}}},ii=function(n){if(n){var t=n.match(/\d/g).join("");t&&(document.location.href="tel:"+t)}},r=localStorage,b=document.URL.indexOf("jfenghost")===-1?"https://my.letsos.com":"",vr=b=="",yr=function(n){return n.substr(0,4).toLowerCase()==="http"},y=!yr(document.URL),ri=function(){var t=kendo.support.mobileOS,n={};return n.pc=!t,n.phone=!n.pc&&!t.tablet,n.tablet=!n.pc&&!n.phone,n}(),g=function(){var t=kendo.support.mobileOS,n={};return n.android=t.android,n.ios=!n.android,n}(),ut={fs:null,getDirectory:function(n,t,i){var r=n.split("/").reverse(),u=ut.fs.root,f=function(n){u.getDirectory(n,{create:t},function(n){u=n;r.length>0?f(r.pop()):i&&i(n)},function(){})};f(r.pop())},getFile:function(n,t){window.resolveLocalFileSystemURL(n,function(n){t&&t(n)},function(){})},moveCopyFile:function(n,t,i,r,u,f){var e=this;e.getFile(n,function(n){e.getDirectory(t,!0,function(t){r?n.moveTo(t,i,function(n){u&&u(n,f)},function(){}):n.copyTo(t,i,function(n){u&&u(n,f)},function(){})})},function(){})},removeFile:function(n){this.getFile(n,function(n){n.remove()},function(){})}},yt=function(n,t){if(y){if(navigator.connection.type!=Connection.NONE)return!0}else if(navigator.onLine)return!0;return n||l(t||"Internet connection is required for this function!"),!1},ui=function(){return r.length==0||r.SyncDate=="0"},tt=function(n,t){var i=new kendo.data.DataSource({data:n.data()});return i.filter(t),i.view()},ft=function(n,t){return tt(n,t).length>0},p=openDatabase("WoDb","1.0","Letsos Service Order",5242880),e={from:null,vwMain:function(){f.navigate(e.from||"#vwMain","none");e.from=null},vwWo:function(){f.navigate("#vwWo")},vwWork:function(){f.navigate("#vwWork")},vwMatl:function(){f.navigate("#vwMatl")},vwLabor:function(){f.navigate("#vwLabor")},vwExp:function(){f.navigate("#vwExp")},vwEquipItem:function(){f.navigate("#vwEquipItem")},vwWorkItem:function(){f.navigate("#vwWorkItem")},vwMatlItem:function(){f.navigate("#vwMatlItem")},vwToolItem:function(){f.navigate("#vwToolItem")},vwLaborItem:function(){f.navigate("#vwLaborItem")},vwExpItem:function(){f.navigate("#vwExpItem")},vwSetting:function(){f.navigate("#vwSetting")}},w={view:function(){var t=n(f.view().element).data("kendoValidator");return t?t.validate():!0},input:function(t){var i=n(f.view().element).data("kendoValidator");return i?i.validateInput(t):!0},btns:{inc:function(t){return t.every(function(t){var i=event,r;return t?(r=i&&n(i.srcElement).closest("a"),!(r&&r.hasClass(t))):!!i})},exc:function(n){return!w.btns.inc(n)}}},pi=function(){var n=f&&f.view().id;return n=="#vwMain"||n=="/"},fi=function(n){f.changeLoadingMessage(n||"Please wait...");f.showLoading()},l=function(t,i,r){var u=n("#msgblk");u.find("div").html(t).removeClass().addClass(i||c.WARN);u.slideDown(1e3);r||setTimeout(function(){u.slideUp(1e3)},Math.max(Math.ceil(t.length/14),4)*1e3)},wi=function(){n("#mainMenu").data("kendoMobileDrawer").hide()},kt=function(){var t=function(t,i){n.each(t,function(t,r){n("#tabs [data-role=tab]").eq(r).toggle(i)})},r=i.wo.OhCd=="E";t([1,2,5],i.isDisp());t([3],!1);t([4],!r)},ei=function(t){var i=t||0;n("#vwSig").find(".k-invalid-msg").hide();n("#btngSig").data("kendoMobileButtonGroup").select(i);n("#sig").toggle(i==0);n("#sig2").toggle(i==1)},bi=function(n){var t=c.DFT;return n.IsCmp?!n.OhCd&&ni(n.JobNo)&&!ur(n.JobCc)||(t=c.SUCCESS):n.PriEmpNo==-1?t=c.FAIL:n.IsSelf&&!n.OnSche&&(t=c.WARN),t},v=function(t,r,u,f){var nt=kendo.template(n("#tmAct").html()),e=[],o=[],h,p,g,w;switch(t){case"copyTkt":var b=fr(r),k=parseInt(b.split("-")[0]),v=ni(k),it=!v&&pt(k);(v&&!ur(b)||it)&&e.push({action:"sv.act."+t,text:"Add Ticket To "+(v?"Work Order":"Job")});break;case"activate":e.push({action:"sv.act."+t,text:"Activate Ticket?",note:"You should not activate the ticket unless the primary technician tells you so.",css:"ls-del-btn"});break;case"del.wo":e.push({action:"sv.act."+t,text:"Delete Ticket",css:"ls-del-btn"});break;case"del.equip":case"del.work":case"del.matl":case"del.tool":case"del.labor":case"del.exp":e.push({action:"sv.act."+t,text:"Confirm Deletion",css:"ls-del-btn"});break;case"sigDiscard":e.push({action:"sv.act."+t,text:"Discard Signature?",note:'Customer signature can only be saved when "Accept" button is clicked.',css:"ls-del-btn"});break;case"closeTkt":if(h=i.isTktCmp(),p=i.isDisp(),i.wo.Labors||o.push("Alert: did you forget entering labor?"),h||e.push({action:"sv.act."+t+".only",text:"Close Ticket Only",note:(i.wo.IsPri?"Only this ticket is closed.":"Ticket will be submitted to primary tech for review.")+' Job is still <span class="ls-alert">OPEN<\/span>.'}),(p||pt(i.wo.JobNo))&&(e.push({action:"sv.act."+t+".addNew",text:(h?"":"Close Ticket & ")+"Add New",note:(h?"Add":(i.wo.IsPri?"Close":"Submit")+" this ticket and add")+' a new ticket for <span class="ls-alert">THIS<\/span> job.'}),p&&(i.wo.IsCmp||(ai()?i.wo.Sig||o.push('Please be aware that customer signature has NOT been saved yet. Customer needs to press "Accept" button to save the signature.'):o.push("Warning: customer has not signed yet!")),i.wo.OnSche&&i.wo.IsPri))){var d=0,c=!1,l=!0;tt(i.ds.wos,[{field:"JobCc",operator:"eq",value:i.wo.JobCc},{field:"IsCmp",operator:"eq",value:!1}]).forEach(function(n){n.IsSelf?d++:(c=!0,!l||li(n)||n.Sig||(l=!1))});d<=1&&(!c||l)?e.push({action:"sv.act."+t+(c?".cmpWoConfirm":".cmpWo"),text:"Complete Work Order",css:"ls-hl-btn",note:'The entire Job is <span style="color:lawngreen">COMPLETED<\/span>.'}):o.push('"Complete Work Order" button will be visible only '+(c&&!l?"after secondary tech closes his ticket.":"when you are completing the last ticket of the work order."))}break;case"closeTktConfirm":e.push({action:"sv.act.closeTkt.cmpWo",text:"Confirmation",css:"ls-del-btn",note:"Complete entire job"});o.push("This job still has secondary tech's ticket. If the secondary tech is doing his own time on his mobile device, you need to make sure he has finished everything before you complete the job. You can review his ticket on your device or talk to him to verify. If you have verified or you are doing paperwork for secondary tech, then you can continue.");break;case"wohist":e.push({action:"sv.act."+t+".viewDispatch",text:"View Work Order Image"});e.push({action:"sv.act."+t+".viewCmtT",text:"View Technician Comments"});break;case"jobNoHold":i.wo.IsSelf&&e.push({action:"sv.act."+t+".unlock",text:"Unlock Ticket To Edit",note:"Dispatcher should authorize first before unlocking.",css:"ls-del-btn"});i.isTktCmpSig()&&e.push({action:"sv.act."+t+".forcePushToServer",text:"Force Pushing To Server",note:"Caution: Do this only if server did not receive the synced data from your device."});break;case"custAccept":e.push({action:"sv.act."+t,text:"Confirmation",note:"I hereby acknowledge the man hours and materials used as listed hereon and agree to pay for the services detailed above within 10 days from receipt of invoice. Note: tools and materials may not reflect those listed on the final invoice."});o.push("Stop here if you are a technician! This button is for customer to click!");break;case"multiSelAll":e.push({action:"sv.act."+t+".sel",text:"Select all"});e.push({action:"sv.act."+t+".delSel",text:"De-select all"});break;case"multiSelLbrGrp":g=u.my;e.push({action:"sv.act."+t,text:(g?"Remove from":"Add to")+" my group"});break;case"srvImg":y&&e.push({action:"sv.act."+t+".addConfirm",text:"Add New",note:"Add a new photo using camera or picking an existing one",css:"ls-hl-btn"});i.ds.curimgs.data().length&&(y&&e.push({action:"sv.act."+t+".replaceConfirm",text:"Replace",note:"Replace this photo with a new one"}),e.push({action:"sv.act."+t+".delImgConfirm",text:"Delete",note:"Delete this photo and description",css:"ls-del-btn"}));break;case"getImgSource":e.push({action:"sv.act.srvImg.camera",text:"Camera",note:"Take photo by camera"});e.push({action:"sv.act.srvImg.gallery",text:"Gallery",note:"Pick an existing photo from album"});break;case"delImgConfirm":e.push({action:"sv.act.srvImg.del",text:"Confirmation",css:"ls-del-btn",note:"Delete photo and description"})}if(e.length){var s=n("ul[data-role=actionsheet]"),a=s.data("kendoMobileActionSheet"),rt=nt(e);a&&a.destroy();n("#app").append(rt);s=n("ul[data-role=actionsheet]");f&&s.attr(f.name,f.val);kendo.init(s,kendo.mobile.ui);a=s.data("kendoMobileActionSheet");a.open(r,u);o.length&&(w="",o.forEach(function(n){w+='<div class="ls-actsht-title">'+n+"<\/div>"}),setTimeout(function(){n("<div>"+w+"<\/div>").prependTo(".km-actionsheet-wrapper").hide().slideDown(500)},500))}},k={pad:null,isDraw:function(){return n("#sig .clearButton").is(":visible")},setMode:function(t){var r,o,u,e;t=t||!1;i.isTktCmpSig()||(n(".typeIt").toggle(t),n(".drawIt, .typed").toggle(!t),r=n(window).width()-28,o=rt.get()-n("#sigBtns").height()-10,i.set("sig.width",t?Math.min(r,ti.Draw.Width):r),i.set("sig.height",t?Math.min(o,ti.Draw.Height):ti.Typed.Height));ri.phone&&(u=window.orientation,e=u==-90||u==90,n("#orienAlert").toggle(t&&!e),n("#btngSig, #sigTop").toggle(!t),n("div[data-role=footer]").toggle(!t||!e),f.view().id=="#vwSig"&&f.view().scroller.reset())}},nt={init:function(t,i,r,u,f,e){var o=this,s=n(t);o._listview={lvEl:s,ds:s.data("kendoMobileListView").dataSource,dsSel:u,fnSelA:f,fnSelB:e};o._compare={ds:i,fds:r}},set:function(t,i){var r=this,e=r._listview.lvEl,f=!!t,u=!1;f?u=!r._set(t,i,!0):n.each(e.find(".ls-sel"),function(t,f){r._set(n(f),i,!1)||(u=!0)});u&&l((f?"Item":"Some item")+" cannot be selected because it already exists in the ticket. Locate and modify the entry instead.",c.FAIL)},autoSet:function(n,t){var i=this,f=i._listview.lvEl,r=f.find(" li[data-uid="+n.uid+"] .ls-sel"),e=r.hasClass("ls-sel-active"),u=t(n);e!=u&&i.set(r,u)},save:function(n){var t=this,i=t._listview,r=i.dsSel,u=r.data();return u.length==0?!1:(u.forEach(function(i){var r=n?n(i):i,u;r&&(u=t._compare.ds.add(r),u.id=0)}),r.data([]),i.ds.cancelChanges(),!0)},curDataItem:function(n){return this._listview.ds.getByUid(n.closest("li").data("uid"))},_listview:{lvEl:null,ds:null,dsSel:null,fnSelA:null,fnSelB:null},_compare:{ds:null,fds:[]},_set:function(n,t,i){var f=this,r=f.curDataItem(n),e=f._listview,h=e.fnSelA,o=e.dsSel,c=f._compare.ds,s=[],l;return(i&&(t=!r.isSel),e.fnSelB&&e.fnSelB(r,t),f._compare.fds.forEach(function(n){s.push({field:n,operator:"eq",value:r[n]})}),l=t&&c.length!=0&&ft(c,s),l)?!1:t==(r.isSel||!1)?!0:(r.isSel=t,n.toggleClass("ls-sel-active"),h&&h(r),t?(r.Ts=u.nAdd(),o.add(r)):(o.filter(s),o.remove(o.view()[0])),!0)}},a={cur:{needSvr:!1,cat:null,ts2:0,isAdd:!1,page:0,set:function(t,r){var u=this;u.cat=t;u.ts2=r;u.needSvr=!1;u.isAdd=!1;var e=tt(i.ds.imgs,[{field:"Cat",operator:"eq",value:t},{field:"Ts2",operator:"eq",value:r}]),o=!!e.length,s=(y||o)&&!i.isTktCmp();if(!o)if(s)u.isAdd=!0;else{l("No existing image can be found!");return}i.ds.curimgs.data(n.map(e,function(n){var e=i.ds.fes.get(n.Ts),f=n.toJSON(),o;return e?f.url=e.Uri:(u.needSvr=!0,Object.keys(d).some(function(n){return o=d[n].Name,d[n].Id==t}),f.url="{0}/docimg/{1}/{2}".formatWith(b,o,a.fileName(i.wo.Ts,r,f.Ts))),f}));i.set("lock.imgAct",!s);f.navigate("#vwImg")},pickSourceType:function(t){this.isAdd=t;v("getImgSource",n("#btnImgAct"))}},filePath:function(n,t){return["doc",n,t].join("/")},fileName:function(n,t,i){return[n,t,i].join("-")+".jpg"},capture:function(t){var c=i.wo.Ts,e=a.cur.ts2,o=a.cur.cat,r=a.cur.isAdd,w=i.ds.curimgs,l=w.data().length,v=a.cur.page,y=function(n,t,u){var s=i.img,a=i.ds.curimgs,l=i.ds.imgs,v={Ts:n,No:t,Desc:"",Cat:o,Ts2:e,url:u},f;r?a.add(v):(l.remove(l.get(s.Ts)),s.id=n,s.Ts=n,s.url=u);i.ds.fes.add({Ts:n,Ts1:c,Ts2:e,Cat:o,Uplded:!1,Uri:u});f=new h.Img;f.Ts=n;f.No=t;f.Cat=o;f.Ts2=e;r?l.add(f):(f.Desc=s.Desc,l.insert(t,f))},p=function(){s(i.ds.imgs,"wo.Imgs");var t=n("#srvImg").data("kendoMobileScrollView");t.scrollTo(r?l:v);t.refresh()},f=u.nnow();t?navigator.camera.getPicture(function(n){var t=function(n,t){y(t.ts,t.pg,n.toURL());p()};ut.moveCopyFile(n,a.filePath(ht.Raw,o),a.fileName(c,e,f),!0,t,{ts:f,pg:r?l:v})},function(){},{destinationType:Camera.DestinationType.FILE_URI,encodingType:Camera.EncodingType.JPEG,sourceType:Camera.PictureSourceType.CAMERA,quality:80,targetWidth:960,targetHeight:1280,correctOrientation:!0}):window.imagePicker.getPictures(function(t){var i=function(t){return n.when.apply(n,n.map(t,function(t,i){var s=new n.Deferred,h=function(n,t){y(t.ts,t.pg,n.toURL());s.resolve()};return f=u.nAdd(1,f),ut.moveCopyFile(t,a.filePath(ht.Raw,o),a.fileName(c,e,f),!0,h,{ts:f,pg:r?l+i:v}),s})).promise()};i(t).done(p)},function(){},{maximumImagesCount:r?15:1,width:1280,height:960,quality:80})}},rt={get:function(){var t=f.view().element;return n(window).height()-t.find("header").height()},adj:function(){y&&g.android?SoftKeyboard.hide():document.activeElement.blur();setTimeout(function(){n(document.body).height(window.innerHeight);!y&&g.ios&&window.scrollTo(0,0)},500)},setImgScrollerH:function(t){var i=t||n("#srvImg .ls-img-scroller");i.length&&(i.height(rt.get()-56),i.data("kendoMobileScroller").reset(),n("#srvImg").data("kendoMobileScrollView").refresh())}},ki=function(t){t.bind("scroll",function(){var t=n(document.activeElement);t.is("[type=search]")&&t.blur()})},f,et=n.parseJSON(r.myguys||null)||[],oi=function(){r.EmpNo&&i.set("setting",new h.Setting({EmpNo:parseInt(r.EmpNo),Ssn4:parseInt(r.Ssn4),Ver:bt,SyncDate:u.dui(u.td(r.SyncDate||u.nnow()),"G")}))},ot={editDeadline:null,ndDataItem:function(n){return n.Date=u.nd(n.Date),n},dnDataItem:function(n){var t=n.toJSON();return t.Date&&(t.Date=u.dn(t.Date)),t}},di=function(t,r){i.set(r,t.data().length==0?null:JSON.stringify(n.map(t.data(),ot.dnDataItem)))},gi=function(){var n=f.view().id;return i[n.toLowerCase().replace("#vw","").replace("item","")]},nr=function(){var n=gi();return!n||n.isNew()?!1:(n.Date||u.td(n.Ts))<u.pd().validFrom},dt={theme:"ios",display:ri.phone?"modal":"bubble",closeOnOverlay:!1},tr=function(){var o=r.EntPkg,u=parseInt(r.DeptNo),s=i.ds.ohlist,t=[{Val:" ",Desc:"REGULAR JOB",JobNo:0,Cc:0}],f,e;o&&(f={vacation:r.EntPkg.substr(0,1)!="0",sick:r.EntPkg.substr(2,1)!="0",holiday:r.EntPkg.substr(4,1)!="0"},f.vacation&&t.push({Val:"V",Desc:"VACATION PAY".formatWith(r.AvailV),JobNo:u,Cc:vt}),f.sick&&t.push({Val:"S",Desc:"SICK LEAVE PAY".formatWith(r.AvailS),JobNo:u,Cc:vt}),f.holiday&&t.push({Val:"H",Desc:"HOLIDAY PAY",JobNo:u,Cc:vt}));n.each(tt(s,{field:"DeptNo",operator:"eq",value:u}),function(n,i){t.push({Val:i.Id.toString(),Desc:i.Desc,JobNo:i.JobNo,Cc:i.Cc})});i.ds.tktTypes.data(t);e=n("[name=nmTktType]");e.html(sv.helper.renderTmpl(n("#tmSelect"),t));e.mobiscroll().select(n.extend({},dt,{rows:7,minWidth:170,onSelect:function(t,r){var f=tt(i.ds.tktTypes,{field:"Val",operator:"eq",value:r.getValue()})[0],u;i.set("wo.OhCd",n.isNumeric(f.Val)?"O":f.Val.trim());u=i.isRegJobExp();i.set("wo.JobNo",u?0:f.JobNo);i.set("wo.Cc",u?0:f.Cc);i.set("wo.CustName",u?"":yi);i.set("wo.Reason",i.isVSHE()?f.Desc:"");i.set("wo.Addr","");i.set("wo.PriEmpNo",u?0:i.wo.RefEmpNo);i.set("wo.IsPri",!u);n("#vwWo").find(".k-invalid-msg").hide();kt();i.wo.OhCd=="E"&&l("You may leave the job# and cost code 0 (zero) if you don't know what to charge to.",c.SUCCESS)}}))},si=function(n){var t=f.view().element.find(".ls-mobi-date"),i=hi(),r=i.dates;t.mobiscroll("option","buttons",["set","cancel"]);t.mobiscroll("option","minDate",i.start);t.mobiscroll("option","maxDate",i.end);t.mobiscroll("option","invalid",[{start:i.start,end:i.end}]);r.length>0&&(t.mobiscroll("option","valid",r),n&&n(r))},hi=function(){var f=u.pd().validFrom,o=new Date,t=i.wo.OhCd,s=function(i,f){for(var s=[],e=i,o=!1,h=function(t){return n.parseJSON(r.Holidays).indexOf(t.getMonth()+1+"/"+t.getDate())!=-1};e<=f;)t=="V"||t=="S"?o=[0,6].indexOf(e.getDay())!=-1||h(e):t=="H"&&(o=!h(e)),o||s.push(e),e=u.addDays(1,e);return s},e=o;return t=="V"||t=="H"?e=u.addDays(30,f):t||ni(i.wo.JobNo)||(e=u.addDays(6,f)),{start:f,end:e,dates:s(f,e)}},ir=function(n,t){var i=n.parent();i.find("span").remove();i.append(sv.helper.fDate.weekdayName(t))},rr=function(r,u,f){var e=n.map(Object.keys(d),function(n){var t=d[n];return t.GrpNo==f?{Val:t.Id,Desc:t.Desc}:null});n("#"+r).html(sv.helper.renderTmpl(n("#tmSelect"),e)).mobiscroll().select(n.extend({},dt,{anchor:n("#"+u),rows:5,minWidth:150,inputClass:"ls-hidden",onSelect:function(n,r){var u;switch(f){case d.Job.GrpNo:u=0;break;case d.Equip.GrpNo:u=i.equip.Ts}u!==t&&a.cur.set(parseInt(r.getValue()),u)}}))},ct=function(t,r,u){var f=function(){var r=n("#woList").data("kendoMobileListView"),f=new kendo.data.DataSource({data:i.ds.wos.data(),filter:{field:"IsCmp",operator:"eq",value:t},sort:[{field:"JobCc",dir:"asc"},{field:"Ts",dir:"asc"}]}),e,o;f.fetch(function(){var s,h;if(t&&!i.viewCmp&&f.view().length==0){l("No completed ticket is found!");return}i.set("viewCmp",t);s=[];f.view().forEach(function(n){n.GrpOrder=n.JobCc===e?o:n.Ts;e=n.JobCc;o=n.GrpOrder;s.push(n)});h=new kendo.data.DataSource({data:s,group:{field:"GrpOrder"},sort:[{field:"IsSelf",dir:"desc"},{field:"Ts",dir:"asc"}]});r?r.setDataSource(h):r=n("#woList").kendoMobileListView({dataSource:h,template:n("#tmWo").html(),headerTemplate:"#= sv.helper.woListHeader(data) #",click:function(n){i.show.wo(n)}}).data("kendoMobileListView");u&&u()})};r?o.wo.read.list(function(n){i.ds.wos.data(n);f()}):f()},ci=function(r,u){ot.editDeadline=null;r.IsActivated===t&&(r.IsActivated=!r.IsSelf||r.isNew()||!r.OnSche||r.IsPri||r.OhCd||!li(r),r.IsActivated||(r.IsSelf=!1));i.set("wo",r);n("[name=nmTktType]").mobiscroll("getInst").setValue(r.OhCd||" ",!0);i.ds.equips.data(r.Equips?n.parseJSON(r.Equips):[]);i.ds.works.data(r.Works?n.parseJSON(r.Works).map(ot.ndDataItem):[]);i.ds.matls.data(r.Matls?n.parseJSON(r.Matls):[]);i.ds.tools.data(r.Tools?n.parseJSON(r.Tools):[]);i.ds.labors.data(r.Labors?n.parseJSON(r.Labors).map(ot.ndDataItem):[]);i.ds.exps.data(r.Exps?n.parseJSON(r.Exps).map(ot.ndDataItem):[]);i.ds.imgs.data(r.Imgs?n.parseJSON(r.Imgs):[]);k.pad.init();k.setMode();ei(0);u?f.navigate("#vwWo","none"):e.vwWo()},ur=function(n){return!ft(i.ds.wos,[{field:"JobCc",operator:"eq",value:n},{field:"IsCmpWo",operator:"eq",value:!1}])},li=function(n){return!n.Works&&!n.Matls&&!n.Tools&&!n.Labors&&!n.Exps&&!n.Recomd&&!n.Misc},s=function(n,t,r,f){var s,e,h;return!f&&!w.view()?!1:n.hasChanges()?(s=!t,s||di(n,t),e=i.wo,e.JobCc=gt(e.JobNo,e.Cc),e.RevDate=u.nnow(),h=function(){f||i.ds.wos.sync();s?ct(i.viewCmp,!1,r):(f||n.sync(),r&&r())},i.wo.isNew()?o.wo.create.multiple([e],h):o.wo.update.multiple([e],h),!0):(r&&r(),!0)},st=function(n,t,u,f,e){var c,l;n.remove(t);var h=!u,s=i.ds.imgs,a=h?s.data():tt(s,[{field:"Ts2",operator:"eq",value:t.Ts}]);if(a.length&&(a.forEach(function(n){s.remove(n)}),h||di(s,"wo.Imgs")),t.isNew()){e();return}h?(ct(i.viewCmp),c=t.Ts,o.wo.destroy.multiple([c],e),l=r.DelCltKeys?JSON.parse(r.DelCltKeys):[],l.push(c),r.DelCltKeys=JSON.stringify(l)):f(n,u,e,!0)},lt=function(n,t,r){n.Ts=u.nnow();t&&i.set(t,n);r&&r()},gt=function(n,t){return n+"-"+t},fr=function(t){return n(t).data("key")},ni=function(n){return n>=0&&n<1e3||n>=7e5&&n<=799999},pt=function(n){return n>=1e3&&n<7e5},wt=function(n){var t=i.ds.techlist.get(n);return t?t.Name:""},ai=function(){return k.isDraw()?k.pad.getSignature().length==0?"":k.pad.getSignatureString():i.wo.SigContact?"A":""},er=function(n){r.DeviceId="~"+n},or=function(){if(y&&!i.isDemo&&i.authened){var n=window.plugins.pushNotification;g.android?n.register(function(){},function(){},{senderID:"31561045929",ecb:"sv.helper.pushNotification.android"}):g.ios&&n.register(er,null,{badge:!0,sound:!0,alert:!0,ecb:"sv.helper.pushNotification.ios"})}},at=function(t){var f=u.nnow(),e=ui(),s=function(t){var u=i.setting.EmpNo,f=i.setting.Ssn4;n.post(b+"/api/z/mobile/validateUser",JSON.stringify({refempno:u,ssn4:f}),function(n){r.EmpNo=u;r.Ssn4=f;r.EmpName=n.EmpName;r.DeptNo=n.DeptNo;r.EntPkg=n.EntPkg;r.AvailV=n.AvailV;r.AvailS=n.AvailS;r.IsDemo=n.IsDemo;i.set("isDemo",n.IsDemo);i.set("authened",!0);t()})},h=function(){var t=n.Deferred();return o.wo.read.changed(function(n){i.wo&&i.wo.forcePushToServer&&(n.push(i.wo.toJSON()),i.wo.forcePushToServer=!1);t.resolve(n)}),t.promise()},v=function(){var t=n.Deferred();return o.wo.read.cltKeys(function(n){var u=r.DeviceId,e,o;u?u.substr(0,1)=="~"?(u=u.substr(1),r.DeviceId=u):u="":or();e={refEmpNo:i.setting.EmpNo,isDemo:i.isDemo,syncDate:f,toolListDate:parseInt(r.ToolListDate),techListDate:parseInt(r.TechListDate),ohListDate:parseInt(r.OhListDate),ver:bt,platform:y?device.platform.toLowerCase()=="android"?1:2:0,osver:y?device.version:"",devId:u};o=r.DelCltKeys?JSON.parse(r.DelCltKeys):[];t.resolve({info:e,cltKeys:n,delCltKeys:o})}),t.promise()},p=function(t){var r=n.Deferred();return t.Wo.Add.length||t.Wo.Upd.length||t.Wo.Del.length?o.wo.create.multiple(t.Wo.Add,function(){o.wo.update.multiple(t.Wo.Upd,function(){o.wo.destroy.multiple(t.Wo.Del,function(){ct(i.viewCmp,!0);r.resolve()})})}):r.resolve(),r.promise()},w=function(t){var u=n.Deferred();return t.Tool.AddUpd?o.tool.createUpdate(t.Tool.AddUpd,function(){r.ToolListDate=t.Tool.RevDate;o.tool.read(function(n){i.ds.toollist.data(n);u.resolve()})}):u.resolve(),u.promise()},k=function(t){var u=n.Deferred();return t.Tech.AddUpd||t.Tech.Del?o.tech.createUpdate(t.Tech.AddUpd,function(){o.tech.destroy(t.Tech.Del,function(){r.TechListDate=t.Tech.RevDate;o.tech.read(function(n){i.ds.techlist.data(n);u.resolve()})})}):u.resolve(),u.promise()},d=function(t){var u=n.Deferred();return t.Oh.AddUpd||t.Oh.Del?o.oh.createUpdate(t.Oh.AddUpd,function(){o.oh.destroy(t.Oh.Del,function(){r.OhListDate=t.Oh.RevDate;o.oh.read(function(n){i.ds.ohlist.data(n);tr();u.resolve()})})}):u.resolve(),u.promise()},g=function(){var t=i.ds.fes,u=tt(t,{field:"Uplded",operator:"eq",value:!1}),f=new FileTransfer,r=new FileUploadOptions;return n.when.apply(n,n.map(u,function(i){var u=new n.Deferred,e=i.Cat,o=i.Uri,s=a.fileName(i.Ts1,i.Ts2,i.Ts);return r.fileName=s,f.upload(o,b+"/api/z/mobile/upldimg/"+e,function(){ut.moveCopyFile(o,a.filePath(ht.Uplded,e),s,!0,function(n){var r=t.get(i.Ts);r.Uplded=!0;r.Uri=n.toURL();u.resolve()})},function(n){l("Error uploading photos: "+n.code)},r),u})).promise()},nt=function(){var t=i.ds.fes;n.map(t.data(),function(n){tt(i.ds.wos,{field:"Ts",operator:"eq",value:n.Ts1}).length||t.remove(n)})};s(function(){n.when(h(),v()).done(function(i,u){n.ajax({type:"POST",url:b+"/api/z/mobile/syncsvr",data:JSON.stringify({info:u.info,changedWos:i,cltKeys:u.cltKeys,deletedCltKeys:u.delCltKeys}),beforeSend:function(){fi("Syncing...")},success:function(i){y&&bt<i.Ver&&l('New app update is available.<p><a href="#" onclick="sv.helper.appUpdate()" class="km-button">Download and Install Now<\/a><\/p>',c.FAIL,!0);n.when(p(i),w(i),k(i),d(i)).done(function(){r.SyncDate=f;r.DelCltKeys="";!i.Holidays||(r.Holidays=JSON.stringify(i.Holidays));t&&t()})}})});!y||i.isDemo||e||g().done(nt)})},sr=function(n){return!vr&&yt(!0)&&(n||pi())},hr=function(){if(sr()){var n=parseInt(r.SyncDate);!!n&&u.dt(u.addHrs(-2))>n&&at()}},vi=function(n){if(sr(n)){if(r.DelCltKeys){at();return}o.wo.read.changed(function(n){n.length&&at()})}},o={init:function(){var n="Ts INTEGER PRIMARY KEY, RefEmpNo INTEGER, PriEmpNo INTEGER, OnSche INTEGER, JobNo INTEGER, Cc INTEGER, OhCd, Resp, RespTel, Reason, Equips, Works, Imgs, Recomd, CustName, CustPo, Addr, Contact, Tel, Matls, Labors, Exps, Tools, Misc, Sig, SigDate INTEGER, SigContact, SigTel, SigEmail, IsCmp INTEGER, CmtC, CmtT, IsCmpWo INTEGER, RevDate INTEGER",t=r.Ver||0,i;t&&t<"1.4.1.9"&&(i="Ts, RefEmpNo, PriEmpNo, OnSche, JobNo, Cc, OhCd, Resp, RespTel, Reason, Equips, Works, Recomd, CustName, CustPo, Addr, Contact, Tel, Matls, Labors, Tools, Misc, Sig, SigDate, SigContact, SigTel, SigEmail, IsCmp, CmtC, CmtT, IsCmpWo, RevDate",p.transaction(function(t){t.executeSql("ALTER TABLE Wo RENAME TO WoTemp");t.executeSql("CREATE TABLE Wo ({0})".formatWith(n));t.executeSql("INSERT INTO Wo ({0}) select {0} FROM WoTemp".formatWith(i));t.executeSql("DROP TABLE WoTemp")}));p.transaction(function(t){t.executeSql("CREATE TABLE IF NOT EXISTS Wo ({0})".formatWith(n));t.executeSql("CREATE TABLE IF NOT EXISTS Tech (No INTEGER PRIMARY KEY, Name)");t.executeSql("CREATE TABLE IF NOT EXISTS Tool (Id INTEGER PRIMARY KEY, Desc)");t.executeSql("CREATE TABLE IF NOT EXISTS Oh (Id INTEGER PRIMARY KEY, JobNo INTEGER, Cc INTEGER, Desc, DeptNo INTEGER)")})},dataToArray:function(n,t){for(var r,f=n.rows.length,u=[],i=0;i<f;i++)r=n.rows.item(i),u.push(t?r[t]:r);return u},wo:{read:{list:function(t){p.transaction(function(r){r.executeSql("SELECT * FROM Wo",[],function(r,u){for(var f,s=u.rows.length,o=[],e=0;e<s;e++)f=n.parseJSON(JSON.stringify(u.rows.item(e))),f.OnSche=f.OnSche==1,f.IsCmp=f.IsCmp==1,f.IsCmpWo=f.IsCmpWo==1,f.JobCc=gt(f.JobNo,f.Cc),f.IsSelf=f.RefEmpNo==i.setting.EmpNo,f.IsPri=f.RefEmpNo==f.PriEmpNo,o.push(f);t(o)})})},single:function(n,t){p.transaction(function(i){i.executeSql("SELECT * FROM Wo WHERE Ts=?",[n],function(n,i){t(i.rows.item(0))})})},changed:function(n){p.transaction(function(t){t.executeSql("SELECT * FROM Wo WHERE RevDate>?",[r.SyncDate],function(t,i){n(o.dataToArray(i))})})},pdSum:function(t,r){p.transaction(function(f){f.executeSql("SELECT Ts, JobNo, Cc, OhCd, CustName, Reason, Labors, RefEmpNo, PriEmpNo, IsCmp, Sig, IsCmpWo, RevDate FROM Wo",[],function(f,e){for(var o,l=e.rows.length,h=[],c=u.pd(),s=0;s<l;s++)o=e.rows.item(s),o.Labors&&n.parseJSON(o.Labors).forEach(function(n){var r=u.nd(n.Date);n.No==t&&r>=c.uiFrom&&r<=c.uiTo&&(o.JobCc=gt(o.JobNo,o.Cc),n.WoTs=o.Ts,n.OhCd=o.OhCd,n.JobCc=o.JobCc,n.CustName=o.CustName,n.Reason=o.Reason,n.Date=r,n.IsSelf=o.RefEmpNo==i.setting.EmpNo,n.PriEmpNo=o.PriEmpNo,n.IsPri=o.PriEmpNo==o.RefEmpNo,n.StsIcon=bi(o),h.push(n))});r(h)})})},cltKeys:function(n){p.transaction(function(t){t.executeSql("SELECT Ts, RevDate FROM Wo",[],function(t,i){n(o.dataToArray(i))})})}},create:{multiple:function(n,t,i){var r=n.length;if(r==0){t&&t();return}p.transaction(function(u){n.forEach(function(n,f){u.executeSql("INSERT INTO Wo (Ts, RefEmpNo, PriEmpNo, OnSche, JobNo, Cc, OhCd, Resp, RespTel, Reason, Equips, Works, Imgs, Recomd, CustName, CustPo, Addr, Contact, Tel, Matls, Labors, Exps, Tools, Misc, Sig, SigDate, SigContact, SigTel, SigEmail, IsCmp, CmtC, CmtT, IsCmpWo, RevDate) VALUES(?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)",[n.Ts,n.RefEmpNo,n.PriEmpNo,n.OnSche?1:0,n.JobNo,n.Cc,n.OhCd,n.Resp,n.RespTel,n.Reason,n.Equips,n.Works,n.Imgs,n.Recomd,n.CustName,n.CustPo,n.Addr,n.Contact,n.Tel,n.Matls,n.Labors,n.Exps,n.Tools,n.Misc,n.Sig,n.SigDate,n.SigContact,n.SigTel,n.SigEmail,n.IsCmp?1:0,n.CmtC,n.CmtT,n.IsCmpWo?1:0,n.RevDate],function(){f==r-1&&t&&t()},function(){i&&i()})})})}},update:{multiple:function(n,t,i){var r=n?n.length:0;if(r==0){t&&t();return}p.transaction(function(u){n.forEach(function(n,f){u.executeSql("UPDATE Wo SET RefEmpNo=?, PriEmpNo=?, OnSche=?, JobNo=?, Cc=?, OhCd=?, Resp=?, RespTel=?, Reason=?, Equips=?, Works=?, Imgs=?, Recomd=?, CustName=?, CustPo=?, Addr=?, Contact=?, Tel=?, Matls=?, Labors=?, Exps=?, Tools=?, Misc=?, Sig=?, SigDate=?, SigContact=?, SigTel=?, SigEmail=?, IsCmp=?, CmtC=?, CmtT=?, IsCmpWo=?, RevDate=? WHERE Ts=?",[n.RefEmpNo,n.PriEmpNo,n.OnSche?1:0,n.JobNo,n.Cc,n.OhCd,n.Resp,n.RespTel,n.Reason,n.Equips,n.Works,n.Imgs,n.Recomd,n.CustName,n.CustPo,n.Addr,n.Contact,n.Tel,n.Matls,n.Labors,n.Exps,n.Tools,n.Misc,n.Sig,n.SigDate,n.SigContact,n.SigTel,n.SigEmail,n.IsCmp?1:0,n.CmtC,n.CmtT,n.IsCmpWo?1:0,n.RevDate,n.Ts],function(){f==r-1&&t&&t()},function(){i&&i()})})})},cmpWo:function(n,t,i){p.transaction(function(r){r.executeSql("UPDATE Wo SET IsCmp=1, IsCmpWo=1 WHERE JobNo=? and Cc=?",[n,t],function(){i&&i()})})}},destroy:{multiple:function(n,t,i){var r=n?n.length:0;if(r==0){t&&t();return}p.transaction(function(u){n.forEach(function(n,f){u.executeSql("DELETE FROM Wo WHERE Ts=?",[n],function(){f==r-1&&t&&t()},function(){i&&i()})})})}}},tool:{read:function(n){p.transaction(function(t){t.executeSql("SELECT * FROM Tool",[],function(t,i){n(o.dataToArray(i))})})},createUpdate:function(n,t,i){var r=n?n.length:0;if(r==0){t&&t();return}p.transaction(function(u){n.forEach(function(n,f){u.executeSql("INSERT INTO Tool (Id, Desc) VALUES(?, ?)",[n.Id,n.Desc],function(){f==r-1&&t&&t()},function(u){u.executeSql("UPDATE Tool SET Desc=? WHERE Id=?",[n.Desc,n.Id],function(){f==r-1&&t&&t()},function(){i&&i()})})})})}},tech:{read:function(n){p.transaction(function(t){t.executeSql("SELECT * FROM Tech",[],function(t,i){n(o.dataToArray(i))})})},createUpdate:function(n,t,i){var r=n?n.length:0;if(r==0){t&&t();return}p.transaction(function(u){n.forEach(function(n,f){u.executeSql("INSERT INTO Tech (No, Name) VALUES(?, ?)",[n.RefEmpNo,n.DisplayName],function(){f==r-1&&t&&t()},function(u){u.executeSql("UPDATE Tech SET Name=? WHERE No=?",[n.DisplayName,n.RefEmpNo],function(){f==r-1&&t&&t()},function(){i&&i()})})})})},destroy:function(n,t){var i=n?n.length:0;if(i==0){t&&t();return}p.transaction(function(r){n.forEach(function(n,u){r.executeSql("DELETE FROM Tech WHERE No=?",[n],function(){u==i-1&&t&&t()})})})}},oh:{read:function(n){p.transaction(function(t){t.executeSql("SELECT * FROM Oh",[],function(t,i){n(o.dataToArray(i))})})},createUpdate:function(n,t,i){var r=n?n.length:0;if(r==0){t&&t();return}p.transaction(function(u){n.forEach(function(n,f){u.executeSql("INSERT INTO Oh (Id, JobNo, Cc, Desc, DeptNo) VALUES(?, ?, ?, ?, ?)",[n.Id,n.JobNo,n.Cc,n.Desc,n.DeptNo],function(){f==r-1&&t&&t()},function(u){u.executeSql("UPDATE Oh SET JobNo=?, Cc=?, Desc=?, DeptNo=? WHERE Id=?",[n.JobNo,n.Cc,n.Desc,n.DeptNo,n.Id],function(){f==r-1&&t&&t()},function(){i&&i()})})})})},destroy:function(n,t){var i=n?n.length:0;if(i==0){t&&t();return}p.transaction(function(r){n.forEach(function(n,u){r.executeSql("DELETE FROM Oh WHERE Id=?",[n],function(){u==i-1&&t&&t()})})})}}},h={Wo:kendo.data.Model.define({id:"Ts",fields:{Ts:{type:"number"},RefEmpNo:{type:"number"},PriEmpNo:{type:"number"},OnSche:{type:"boolean"},JobNo:{type:"number"},Cc:{type:"number"},OhCd:{defaultValue:""},Resp:{},RespTel:{},Reason:{},Equips:{},Works:{},Imgs:{},Recomd:{},CustName:{},CustPo:{},Addr:{},Contact:{},Tel:{},Matls:{},Labors:{},Exps:{},Tools:{},Misc:{},Sig:{},SigDate:{type:"number",nullable:!0},SigContact:{},SigTel:{},SigEmail:{},IsCmp:{type:"boolean"},CmtC:{},CmtT:{},IsCmpWo:{type:"boolean"},RevDate:{type:"number"},JobCc:{},IsSelf:{type:"boolean",defaultValue:!0},IsPri:{type:"boolean"},IsActivated:{type:"boolean",defaultValue:!0}}}),Equip:kendo.data.Model.define({id:"Ts",fields:{Ts:{type:"number"},Mfr:{},Model:{},Serial:{},Loc:{},Spec:{}}}),Work:kendo.data.Model.define({id:"Ts",fields:{Ts:{type:"number"},Date:{type:"date"},Desc:{}}}),Matl:kendo.data.Model.define({id:"Ts",fields:{Ts:{type:"number"},PoNo:{},Qty:{},Desc:{}}}),Tool:kendo.data.Model.define({id:"Ts",fields:{Ts:{type:"number"},Id:{type:"number"},Desc:{},Qty:{type:"number",defaultValue:1},Days:{type:"number",defaultValue:1}}}),Labor:kendo.data.Model.define({id:"Ts",fields:{Ts:{type:"number"},Cat:{defaultValue:""},Date:{type:"date"},No:{type:"number"},Name:{},ST:{type:"number",nullable:!0},OT:{type:"number",nullable:!0},DT:{type:"number",nullable:!0},TT:{type:"number",nullable:!0}}}),Oh:kendo.data.Model.define({id:"Id",fields:{Id:{type:"number"},Desc:{},JobNo:{type:"number"},Cc:{type:"number"},DeptNo:{type:"number"}}}),Emp:kendo.data.Model.define({id:"No",fields:{No:{type:"number"},Name:{}}}),Setting:kendo.data.Model.define({fields:{EmpNo:{type:"number",nullable:!0},Ssn4:{type:"number",nullable:!0},Ver:{},SyncDate:{}}}),AdvSearch:kendo.data.Model.define({fields:{Keyword:{},JobNo:{type:"number",nullable:!0},Cc:{type:"number",nullable:!0},Cust:{},Reason:{},Addr:{},Tech:{},Resp:{},OpDateF:{type:"date",nullable:!0},OpDateT:{type:"date",nullable:!0},CmDateF:{type:"date",nullable:!0},CmDateT:{type:"date",nullable:!0}}}),Img:kendo.data.Model.define({id:"Ts",fields:{Ts:{type:"number"},Cat:{type:"number"},Ts2:{type:"number"},No:{type:"number"},Desc:{}}}),Exp:kendo.data.Model.define({id:"Ts",fields:{Ts:{type:"number"},Date:{type:"date"},No:{type:"number"},Name:{},Amt:{type:"number",nullable:!0},Desc:{}}}),FileEntry:kendo.data.Model.define({id:"Ts",fields:{Ts:{type:"number"},Ts1:{type:"number"},Ts2:{type:"number"},Cat:{type:"number"},Uplded:{type:"boolean"},Uri:{}}})},i=kendo.observable({viewCmp:!1,authened:!!r.EmpNo,isDemo:r.IsDemo=="true",isDisp:function(){return!i.get("wo.OhCd")&&ni(i.get("wo.JobNo"))},isDispCons:function(){return i.get("isDisp")()||pt(i.get("wo.JobNo"))},isVSH:function(){var n=i.get("wo.OhCd");return n=="V"||n=="S"||n=="H"},isVSHE:function(){return i.get("wo.OhCd")=="E"||i.isVSH()},isTktCmp:function(){return!i.get("wo.Unlock")&&(!i.get("wo.IsSelf")||i.get("wo.IsCmp"))},isTktCmpSig:function(){return!i.get("wo.Unlock")&&(!!i.get("wo.Sig")||i.isTktCmp())},isRegJobExp:function(){return!i.get("wo.OhCd")||i.get("wo.OhCd")=="E"},deletable:!1,cont:{viewTitle:function(){return i.get("viewCmp")?"Completed":"Active"},titleColor:function(){return i.get("viewCmp")?"#00ff00":"#ffffff"},custName:function(){return i.isDisp()?"Cust. Name":"Job Name"},reason:function(){return i.isDisp()?"Reason For Call":"Work Performed/Description"},phReason:function(){return!pt(i.get("wo.JobNo"))||i.get("wo.Cc")==ar?"required":""},availHrVS:function(){var n=i.get("wo.OhCd")=="V"?r.AvailV:r.AvailS,t=n>=0?n:'<span class="ls-alert">'+n+"<\/span>";return t+" hrs available up to last pay period"},tktOwner:function(){var t=i.get("wo.RefEmpNo"),n;return t==i.setting.EmpNo?"":(n=wt(t),n?"Ticket Owner "+n:"Invalid ticket owner. Call office.")},priTech:function(){var t=i.get("wo.PriEmpNo"),n;return t==i.setting.EmpNo?"":(n=wt(t),n?"Primary Tech "+n:"Invalid primary tech. Call office.")}},lock:{user:function(){return i.get("authened")&&!i.get("isDemo")},recomAdd:function(){return!!i.get("wo.Recomd")||i.isTktCmp()},cmp:function(){return!i.get("wo.IsSelf")||i.get("wo.IsCmpWo")||i.get("wo.PriEmpNo")<=0},ohcd:!0,jobcc:function(){return i.get("wo.OnSche")||!i.isRegJobExp()||i.isTktCmp()},custName:function(){return i.get("wo.Sig")||!i.isRegJobExp()||i.isTktCmp()},tktOwner:function(){return i.get("wo.RefEmpNo")==i.setting.EmpNo},priTech:function(){return i.get("wo.PriEmpNo")==i.setting.EmpNo||i.get("wo.PriEmpNo")<=0},VS:function(){return i.get("wo.OhCd")!="V"&&i.get("wo.OhCd")!="S"||i.isTktCmp()},dtl:function(){return i.isTktCmpSig()||nr()},exp:function(){return i.isTktCmp()||nr()},lbrSel:!0,invalidJobCc:function(){return i.get("wo.PriEmpNo")==-1},isRecomBlank:function(){return!i.get("wo.Recomd")},imgAct:!1},jobNoChange:function(){f.view().element.find(".k-invalid-msg").hide();i.set("wo.CustName","");i.set("wo.Addr","");kt()},multiSel:{tap:function(n){i.multiSel._flag.isHold||nt.set(n.touch.target)},holdSelAll:function(n){i.multiSel._flag.isHold=!0;v("multiSelAll",n.touch.target,null,{name:"data-close",val:"sv.vm.multiSel._flag.reset"})},holdLbr:function(n){if(!i.labor.isD){i.multiSel._flag.isHold=!0;var t=n.touch.target;v("multiSelLbrGrp",t,nt.curDataItem(t),{name:"data-close",val:"sv.vm.multiSel._flag.reset"})}},input:function(t){var r=t.data,i=t.target,u=n(i).data("id"),f=function(){nt.autoSet(r,function(n){var t=i.value;i.type=="number"&&(t=Number(t)||0);switch(u){case"toolQty":return n.Qty=t,t>0;case"lbrST":return n.ST=t,n.ST>0||n.OT>0;case"lbrOT":return n.OT=t,n.ST>0||n.OT>0}return!1})};f()},_flag:{isHold:!1,reset:function(){i.multiSel._flag.isHold=!1}}},sig:{width:0,height:0},wo:{},equip:{},work:{},matl:{},tool:{},labor:{},exp:{},img:{},setting:{},advSearch:{},ds:{wos:new kendo.data.DataSource({schema:{model:h.Wo}}),equips:new kendo.data.DataSource({schema:{model:h.Equip},sort:{field:"Ts",dir:"asc"}}),works:new kendo.data.DataSource({schema:{model:h.Work},sort:[{field:"Date",dir:"asc"},{field:"Ts",dir:"asc"}]}),matls:new kendo.data.DataSource({schema:{model:h.Matl},sort:{field:"Ts",dir:"asc"}}),tools:new kendo.data.DataSource({schema:{model:h.Tool},sort:{field:"Ts",dir:"asc"}}),labors:new kendo.data.DataSource({schema:{model:h.Labor},sort:[{field:"Date",dir:"asc"},{field:"Name",dir:"asc"},{field:"Cat",dir:"asc"}],group:{field:"Date"}}),exps:new kendo.data.DataSource({schema:{model:h.Exp},sort:[{field:"Name",dir:"asc"},{field:"Date",dir:"asc"},{field:"Ts",dir:"asc"}],group:{field:"No"}}),curimgs:new kendo.data.DataSource({schema:{model:h.Img},sort:{field:"No",dir:"asc"}}),imgs:new kendo.data.DataSource({schema:{model:h.Img},sort:[{field:"Cat",dir:"asc"},{field:"Ts2",dir:"asc"},{field:"No",dir:"asc"}],change:function(n){if(n.action=="remove"){var t=i.ds.fes.get(n.items[0].Ts);t&&i.ds.fes.remove(t)}}}),fes:new kendo.data.DataSource({schema:{model:h.FileEntry},change:function(n){n.action=="remove"&&ut.removeFile(n.items[0].Uri)}}),toollist:new kendo.data.DataSource({sort:{field:"Desc",dir:"asc"}}),techlist:new kendo.data.DataSource({schema:{model:h.Emp},sort:{field:"Name",dir:"asc"}}),ohlist:new kendo.data.DataSource({schema:{model:h.Oh}}),tktTypes:new kendo.data.DataSource,techCmtHist:new kendo.data.DataSource,hist:new kendo.data.DataSource({transport:{read:{url:b+"/api/z/mobile/searchhist",type:"POST"},parameterMap:function(n){var i,t,r;if(n.filter)return t=n.filter.filters[0].value,i=typeof t=="object"?t:new h.AdvSearch({Keyword:t}),r={cri:i,count:n.pageSize,page:n.page},JSON.stringify(r)}},serverPaging:!0,serverFiltering:!0,pageSize:150,schema:{data:"Results",total:"Total"},requestStart:function(n){n.sender._filter&&yt()||n.preventDefault()},requestEnd:function(n){n.response&&n.response.Total||l("no record is found!")}}),timesheet:new kendo.data.DataSource},mainMenu:{tgView:function(){ct(!i.viewCmp);wi();f.view().scroller.reset()},addTkt:function(){var n=i.ds.wos.add();n.Ts=u.nnow();n.RefEmpNo=i.setting.EmpNo;ci(n,!0)},timesheet:function(){n.getJSON(b+"/api/z/mobile/searchtimesheet",{refEmpNo:i.setting.EmpNo},function(n){i.ds.timesheet.data(n);f.navigate("#vwTimesheet")});wi()}},show:{wo:function(n){ci(i.ds.wos.get(n.dataItem.Ts))},equip:function(n){i.set("equip",n.dataItem);e.vwEquipItem()},work:function(n){i.set("work",n.data);e.vwWorkItem()},matl:function(n){i.set("matl",n.dataItem);e.vwMatlItem()},tool:function(n){i.set("tool",n.dataItem);e.vwToolItem()},labor:function(n){i.set("labor",n.dataItem);e.vwLaborItem()},exp:function(n){i.set("exp",n.dataItem);e.vwExpItem()},img:{catWo:function(){s(i.ds.wos,"",function(){n("#imgCatWo").mobiscroll("show")})},catEquip:function(){s(i.ds.equips,"wo.Equips",function(){n("#imgCatEquip").mobiscroll("show")})},exp:function(){var n=function(){a.cur.set(d.Exp.Id,i.exp.Ts)};y&&i.exp.isNew()?s(i.ds.exps,"wo.Exps",n):n()},act:function(n){v("srvImg",n.button)}},toolsearch:function(){n("#diaToolSearch").data("kendoMobileModalView").open()},techsearch:function(){n("#diaTechSearch").data("kendoMobileModalView").open()},setting:function(){e.vwSetting()},cmtD:function(){n.getJSON(b+"/api/z/mobile/viewTtkt",{jobno:i.wo.JobNo,costcode:i.wo.Cc},function(t){if(!t.CmtD1&&!t.CmtD2){l("T-Ticket is empty.");return}n("#cmtD1").text(t.CmtD1);n("#cmtD2").text(t.CmtD2);f.navigate("#vwCmtD")})},map:function(){var n="http://maps.google.com/?q={0}";y&&(n=g.android?"geo:0,0?q={0}":"http://maps.apple.com/?q={0}");sv.helper.clickExtLink(n.formatWith(encodeURIComponent(i.wo.Addr)))},dial:function(){ii(i.wo.Tel)},dialResp:function(){ii(i.wo.RespTel)},dialSig:function(){ii(i.wo.SigTel)},getEmail:function(){n.getJSON(b+"/api/z/mobile/getWoCustEmail",{jobno:i.wo.JobNo,costcode:i.wo.Cc},function(n){i.set("wo.SigEmail",n)})},advSearch:function(){var t=i.ds.hist,n=i.advSearch.toJSON();n.OpDateF=u.dui(n.OpDateF);n.OpDateT=u.dui(n.OpDateT);n.CmDateF=u.dui(n.CmDateF);n.CmDateT=u.dui(n.CmDateT);t.filter({field:"keywordObj",operator:"eq",value:n});f.navigate("#vwHist")},recomd:function(t){n("#recomdWrapper").show("slow");t.button.hide()}},add:{equip:function(){lt(i.ds.equips.add(),"equip",e.vwEquipItem)},work:function(){if(w.view()){var n=i.ds.works.add();n.Date=u.today();lt(n,"work",e.vwWorkItem)}},matl:function(){lt(i.ds.matls.add(),"matl",e.vwMatlItem)},tool:function(){lt(i.ds.tools.add(),"tool",e.vwToolItem)},labor:function(n){if(w.bfAddLaborItem()){var t=i.ds.labors.add(),f=n.button.data("dftdate");t.Date=f?u.nd(f):u.today();t.No=i.setting.EmpNo;t.Name=r.EmpName;lt(t,"labor",e.vwLaborItem)}},exp:function(n){var t=i.ds.exps.add(),f=n.button.data("dftno"),o=f||i.setting.EmpNo,s=f?wt(o):r.EmpName;t.Date=u.today();t.No=o;t.Name=s;lt(t,"exp",e.vwExpItem)},equips:function(){n.getJSON(b+"/api/z/mobile/getEquipHist",{jobno:i.wo.JobNo,costcode:i.wo.Cc,refempno:i.setting.EmpNo},function(t){var r=n.parseJSON(t.Equips);if(t.ShowSel&&r.length!==1){var u="#equipSel",e=new kendo.data.DataSource({schema:{model:h.Equip},data:r,sort:{field:"Mfr",dir:"asc"}}),o=new kendo.data.DataSource({schema:{model:h.Equip}});f.navigate("#vwEquips");n(u).data("kendoMobileListView").setDataSource(e);nt.init(u,i.ds.equips,["Mfr","Model","Serial"],o)}else i.ds.equips.data(r),i.set("wo.Equips",JSON.stringify(r)),l("Equip list may not be accurate. Please verify with actual and update if needed.",c.SUCCESS)})},tools:function(){f.navigate("#vwTools")},labors:function(t){if(w.view()){var r=i.labor,e=t.button.data().d,o=e?"D":"E";r.isD=e;i.ds.labors.remove(r);n("#lbrSelTitle"+o).html("Job "+i.wo.JobCc+(e?" for "+r.Name:" on "+u.dui2(r.Date))+" "+sv.helper.shiftDesc(r.Cat));f.navigate("#vwLabors"+o)}}},save:{wo:function(){i.wo.Unlock&&i.set("wo.Unlock",!1);s(i.ds.wos,"",e.vwMain)},activate:function(n){v("activate",n.button)},sigBack:function(n){w.view()&&(!i.isTktCmpSig()&&ai()?v("sigDiscard",n.button):i.save.wo())},acceptC:function(n){if(n.preventDefault(),k.isDraw()&&k.pad.getSignature().length==0){l("Handwritten signature is required at draw mode",c.FAIL);return}w.view()&&v("custAccept",n.button)},acceptT:function(n){n.preventDefault();(!i.isDisp()||w.view())&&v("closeTkt",n.button)},equip:function(){s(i.ds.equips,"wo.Equips",e.vwWork)},work:function(){s(i.ds.works,"wo.Works",e.vwWork)},matl:function(){s(i.ds.matls,"wo.Matls",e.vwMatl)},tool:function(){s(i.ds.tools,"wo.Tools",e.vwMatl)},labor:function(){s(i.ds.labors,"wo.Labors",e.vwLabor)},exp:function(){s(i.ds.exps,"wo.Exps",e.vwExp)},img:function(){s(i.ds.imgs,"wo.Imgs",function(){f.navigate("#:back")})},setting:function(){if(w.view()){if(!i.setting.dirty&&!ui()){e.vwMain();return}i.set("authened",!1);i.set("viewCmp",!1);at(function(){oi();e.vwMain();f.view().scroller.reset()})}},equips:function(){var t=function(n){return new h.Equip({Ts:n.Ts,Mfr:n.Mfr,Model:n.Model,Serial:n.Serial,Loc:n.Loc,Spec:n.Spec})},n=e.vwWork;nt.save(t)?s(i.ds.equips,"wo.Equips",n):n()},tools:function(){var t=function(n){return n.Qty>0?new h.Tool({Ts:n.Ts,Id:n.Id,Desc:n.Desc,Qty:n.Qty,Days:n.Days}):null},n=e.vwMatl;nt.save(t)?s(i.ds.tools,"wo.Tools",n):n()},labors:function(){var t=function(n){return n.ST||n.OT||n.DT||n.TT?new h.Labor({Ts:n.Ts,Cat:n.Cat,Date:n.Date,No:n.No,Name:n.Name,ST:n.ST,OT:n.OT,DT:n.DT,TT:n.TT}):null},n=e.vwLabor;nt.save(t)?s(i.ds.labors,"wo.Labors",n):n()}},del:{wo:function(n){v("del.wo",n.button)},equip:function(n){v("del.equip",n.button)},work:function(n){v("del.work",n.button)},matl:function(n){v("del.matl",n.button)},tool:function(n){v("del.tool",n.button)},labor:function(n){v("del.labor",n.button)},exp:function(n){v("del.exp",n.button)}},sync:function(){yt()&&at()}});return{vm:i,init:function(){var t=ui(),u;t&&(r.SyncDate=0,r.ToolListDate=0,r.TechListDate=0,r.OhListDate=0);o.init();r.Ver=bt;oi();f=new kendo.mobile.Application(document.body,{platform:"ios",initial:t?"vwSetting":"vwMain",statusBarStyle:y&&g.ios&&kendo.support.mobileOS.flatVersion>=700?"black-translucent":"black",transition:"slide",loading:"<h1>Please wait...<\/h1>"});kendo.UserEvents.defaultThreshold(20);n.ajaxSetup({contentType:"application/json",dataType:"json",beforeSend:function(n){if(!yt()){n.abort();return}fi()},error:function(n,t){var f=n.status,o=n.responseText,u;if(f==401)r.clear(),i.set("authened",!1),e.vwSetting(),u="Invalid user name/passwod, or user is not an active Letsos employee.";else{try{u=JSON.parse(o).Message}catch(s){u=o}u+=f==500||f==0&&t?" Server may be temporally under maintenance or no internet connection. Please try again later.":""}l(u,c.FAIL)},complete:function(){f.hideLoading()}});n(document).on("click","input[type=search]",function(){this.select()});n(document).on("submit","form",function(){n("input[type=search]").blur()});if(kendo.data.binders.dateValue=kendo.data.Binder.extend({init:function(t,i,r){kendo.data.Binder.fn.init.call(this,t,i,r);var u=this;n(u.element).on("change",function(){u.change()})},refresh:function(){var t=this,i=t.bindings.dateValue.get(),u=kendo.toString(i,"M/d/yyyy"),r=n(t.element);r.val(u);ir(r,i)},change:function(){var t=this.element.value,n=kendo.parseDate(t,"M/d/yyyy");n&&this.bindings.dateValue.set(n)}}),rt.adj(),window.onerror=function(n){alert("Oops, you caught a bug. Please report the error below to Jason (x3388), then {0}.\n\n{1}".formatWith(y?"re-start the app":"refresh the page",n));y&&g.android&&navigator.app.exitApp()},window.addEventListener("orientationchange",function(){var n=function(){var n=f.view(),t=n.id;switch(t){case"#vwImg":rt.setImgScrollerH();break;case"#vwSig":if(!ri.phone)break;k.setMode(k.isDraw());k.pad.clearCanvas()}},t=function(t){setTimeout(function(){n();t&&t()},200)};g.ios?(n(),rt.adj()):g.android&&t(rt.adj)}),y)document.addEventListener("resume",function(){hr()}),window.requestFileSystem(LocalFileSystem.PERSISTENT,0,function(n){ut.fs=n;var t=a.filePath("{0}","{1}"),r=function(n,t,r){var u=n.createReader();u.readEntries(function(n){n.forEach(function(n){if(n.isFile){var u=n.name.toLowerCase().replace(".jpg","").split("-");i.ds.fes.add({Ts:parseInt(u[2]),Ts1:parseInt(u[0]),Ts2:parseInt(u[1]),Cat:r,Uplded:t==ht.Uplded,Uri:n.toURL()})}})},function(){})};[ht.Raw,ht.Uplded].forEach(function(n){Object.keys(d).forEach(function(i){var u=d[i].Id;ut.getDirectory(t.formatWith(n,u),!1,function(t){r(t,n,u)})})})},function(n){l("Error accessing local file system: "+n.target.error.code,c.FAIL)}),g.android?(document.addEventListener("pause",function(){vi()}),document.addEventListener("backbutton",function(){if(pi())navigator.app.exitApp();else{var n=f.element.find("div[data-role=navbar]:visible:last .km-leftitem a"),t=n.attr("href"),i=n.data("click"),r=n.data("bind");if(t)f.navigate(t);else if(i||r){var e=function(n,t){for(var u=Array.prototype.slice.call(arguments,2),i=n.split("."),f=i.pop(),r=0;r<i.length;r++)t=t[i[r]];return t[f].apply(t,u)},o=function(){var n=r.split(",").filter(function(n){return n.substr(0,6)=="click:"});return n[0].substr(6).trim()},u=i||o(),s=u.substr(0,3)=="sv."?"":f.view().element.data("model")+".";document.activeElement.blur();e(s+u,window,n)}else navigator.app.backHistory()}})):document.addEventListener("resign",function(){vi()}),or();else{if(u=window.location.hash.toLowerCase(),u=="")return;(!t&&u!="#vwmain"||t&&u!="#vwsetting")&&window.location.replace(b+"/m")}},ui:{vwInit:function(t){var s=t.view,r=s.id,y,u,p,e,f,g;switch(r){case"/":case"#vwMain":o.oh.read(function(n){u=i.ds.ohlist;u.data(n);tr()});o.tech.read(function(t){i.ds.techlist.data(t);n("#lstTechSearch").kendoMobileListView({dataSource:i.ds.techlist,template:n("#tmTechSearch").text(),filterable:{field:"Name",operator:"contains"},click:function(n){var t=gi();t.set("No",n.dataItem.No);t.set("Name",n.dataItem.Name);sv.ui.closeModalView()}})});o.tool.read(function(n){i.ds.toollist.data(n)});k.pad=n("#sig").signaturePad({lineWidth:0});n("#btngSig").kendoMobileButtonGroup({select:function(){ei(this.selectedIndex)},index:0});n(".ls-mobi-date").mobiscroll().date(n.extend({},dt,{minWidth:[60,90,65],dateOrder:"MD dyy",onBeforeShow:function(t){t.setDate(n.mobiscroll.parseDate("m/d/yy",n(this).val()),!1)},onClose:function(t,i){i=="clear"&&ir(n(this),null)}}));ct(!1,!0);break;case"#vwWo":f=n(r).kendoValidator({rules:{custName:function(n){return n.is("[name=nmCustName]")?(f.options.messages.custName=i.cont.custName()+" is required",n.val()):!0},addr:function(n){return n.is("[name=nmAddr]")?n.val()||!i.isDisp():!0},reason:function(n){return n.is("[name=nmReason]")?(f.options.messages.reason=i.cont.reason()+" is required",n.val()||n.attr("placeholder")==""):!0},notOh:function(t){if(t.is("[name=nmCc]")){var r=i.wo,e=r.JobNo,u=r.Cc;i.ds.tktTypes.filter([{field:"JobNo",operator:"eq",value:e},{field:"Cc",operator:"eq",value:u}]);var o=i.ds.tktTypes.view(),f=o.length>0&&n.isNumeric(o[0].Val),h=function(){return(u==vt||u==vt-99e4)&&["vacation","sick","holiday"].some(function(n){return r.Reason&&r.Reason.toLowerCase().indexOf(n)!=-1||r.CustName&&r.CustName.toLowerCase().indexOf(n)!=-1})};if(f||h())return!1;f=ft(i.ds.ohlist,[{field:"JobNo",operator:"eq",value:e},{field:"Cc",operator:"eq",value:u}]);f&&(i.set("wo.OhCd","O"),i.set("wo.CustName",yi),s.element.find(".k-invalid-msg").hide(),kt())}return!0},uniqueVSH:function(n){if(n.is("[name=nmTktType]")){u=i.ds.wos;var t=n.val(),r=i.wo.Ts;if(t=="V"||t=="S"||t=="H")return!ft(u,[{field:"OhCd",operator:"eq",value:t},{field:"IsCmp",operator:"eq",value:!1},{field:"Ts",operator:"neq",value:r}])}return!0}},messages:{notOh:'Can not be overhead. Tap "Regular Job" and select from list instead',custName:"Customer name is required",reason:"Reason for call is required",addr:"Address is required",uniqueVSH:"Active ticket already exists"}}).data("kendoValidator");rr("imgCatWo","btnImgWo",d.Job.GrpNo);break;case"#vwWork":n(r).kendoValidator({validateOnBlur:!1,rules:{hasEquip:function(n){return n.is("[name=recomd]")?i.ds.equips.data().length!=0||w.btns.inc(["ls-addwork"]):!0}},messages:{hasEquip:"Enter equipment first. NA for none"}});break;case"#vwLabor":w.bfAddLaborItem=function(){var t=n("#lbrInvalid"),r=t.find("#lbrInvalidMsg");return i.isDisp()&&i.ds.works.data().length==0?(r.text("Enter work performed first"),t.show(),!1):i.wo.OhCd=="H"&&hi().dates.length==0?(r.text("No public holiday is available"),t.show(),!1):!0};break;case"#vwSig":n(r).kendoValidator({validateOnBlur:!1,rules:{emails:function(n){var t,r,u;return n.is("[name=Email]")?(t=n.val(),!t)?!0:(r="[A-Za-z0-9._%-]+@[A-Za-z0-9.-]+.[A-Za-z]{2,4}",u=new RegExp("^"+r+"(;\\n*"+r+")*;?$"),i.set("wo.SigEmail",t.replace(",",";").replace(" ","")),u.test(i.wo.SigEmail)):!0},workReq:function(n){return n.is("[name=Contact]")?!!i.wo.Works||!event||w.btns.inc(["ls-sig-accept"]):!0},toolReq:function(n){return n.is("[name=Contact]")?i.wo.Tools||!i.wo.Works||w.btns.inc(["ls-sig-accept","ls-sig-compl"]):!0},contactReq:function(n){return n.is("[name=Contact]")?n.val()!=""||w.btns.inc(["ls-sig-accept","ls-sig-draw"]):!0}},messages:{emails:"Invalid email address",workReq:"Work Performed is missing",toolReq:"Tool Rental is missing (NA for none)",contactReq:"Contact is required"}});break;case"#vwWorkItem":n(r).kendoValidator({rules:{desc:function(n){return n.is("[name=nmDesc]")?n.val().trim().replace(/\n/g,"").length>=25:!0}},messages:{desc:"Description has to be at least 25 characters"}});break;case"#vwEquipItem":n(r).kendoValidator();rr("imgCatEquip","btnImgEquip",d.Equip.GrpNo);break;case"#vwSetting":case"#vwMatlItem":n(r).kendoValidator();break;case"#vwToolItem":n("#lstToolSearch").kendoMobileListView({dataSource:i.ds.toollist,template:n("#tmToolSearch").html(),filterable:{field:"Desc",operator:"contains"},click:function(n){i.tool.set("Id",n.dataItem.Id);i.tool.set("Desc",n.dataItem.Desc);sv.ui.closeModalView()}});n(r).kendoValidator({validateOnBlur:!1,rules:{qtyAndDays:function(n){if(n.is("[name=nmToolQty]")){var t=i.tool.Desc.replace("/","").replace(" ","").toLowerCase(),r=t=="na"||t=="none";return r&&(i.set("tool.Qty",0),i.set("tool.Days",0)),r||i.tool.Qty&&i.tool.Days}return!0}},messages:{qtyAndDays:"Quantity/Days can not be zero"}});break;case"#vwLaborItem":case"#vwExpItem":p=r=="#vwLaborItem";p?(n("#shift").mobiscroll().select(n.extend({},dt,{rows:5,minWidth:120,onSelect:function(n,t){i.set("labor.Cat",t.getValue().trim())}})),f=n(r).kendoValidator({rules:{hrs:function(n){if(n.is("[name=ST]")){var t=f.options.messages;if(!(i.labor.ST||i.labor.OT||i.labor.DT||i.labor.TT))return t.hrs="Can not leave all hours blank",!1;if(i.isVSH()){if((i.labor.ST||0)>10)return t.hrs="Total daily hours can not be over 10",!1}else if((i.labor.ST||0)+(i.labor.OT||0)+(i.labor.DT||0)+(i.labor.TT||0)>24)return t.hrs="Total daily hours can not be over 24",!1}return!0},techUnique:function(n){return n.is("[name=ST]")?w.btns.inc(["ls-lbr-back",""])||!ft(i.ds.labors,[{field:"Cat",operator:"eq",value:i.labor.Cat},{field:"No",operator:"eq",value:i.labor.No},{field:"Date",operator:"eq",value:i.labor.Date},{field:"Ts",operator:"neq",value:i.labor.Ts}]):!0}},messages:{hrs:"Error",techUnique:"Tech exists on same date"}}).data("kendoValidator"),e={nmTechNo:"nmTechNo",vmEle:"labor"}):(f=n(r).kendoValidator({rules:{hasImg:function(n){return n.is("[name=nmAmtExp]")?w.btns.inc(["ls-exp-back",""])||ft(i.ds.imgs,{field:"Ts2",operator:"eq",value:i.exp.Ts}):!0}},messages:{hasImg:"Photo of the receipt is required"}}).data("kendoValidator"),e={nmTechNo:"nmTechNoExp",vmEle:"exp"});n.extend(f.options.rules,{techNo:function(n){if(n.is("[name="+e.nmTechNo+"]")){var t=wt(n.val());return i.set(e.vmEle+".Name",t),t!=""}return!0}});n.extend(f.options.messages,{techNo:"Invalid tech no."});n("input[name="+e.nmTechNo+"]").keyup(function(){var t=n(this);setTimeout(function(){w.input(t)},1e3)});break;case"#vwHist":y='<a href="\\#"><div class="ls-itm ls-ellipsis">#: JobNo #-#: Cc # #: CustName #<\/div><div class="ls-itm-dtl ls-font-normal ls-ellipsis">#: CmpDate # <span class="ls-font-normal">#: Reason #<\/span><\/div><\/a>';n("#lstHist").kendoMobileListView({dataSource:i.ds.hist,autoBind:!1,template:y,filterable:{autoFilter:!1,placeholder:"job-costcode or keyword(s)"},endlessScroll:!0,click:function(n){n&&(n.preventDefault(),v("wohist",n.target,{jobno:n.dataItem.JobNo,cc:n.dataItem.Cc,wo:n.dataItem.Wo}))}});g=s.element.find(".km-filter-wrap");g.css({"margin-right":"5.5em",overflow:"hidden"}).after('<div style="float:right; margin-top:-1.7em; margin-right:.5em; color: black;"><a href="#vwAdvSearch">advanced<\/a><\/div>');ki(s.scroller);break;case"#vwTimesheet":y='<a><span class="ls-itm"><span class="ls-font-normal">Week Ending<\/span> #= WkEnd #<\/span><\/a>';n("#lstTimesheet").kendoMobileListView({dataSource:i.ds.timesheet,template:y,click:function(t){t.preventDefault();n.getJSON(b+"/api/z/mobile/viewtimesheet",{refempno:i.setting.EmpNo,wkend:t.dataItem.WkEnd},function(n){sv.helper.clickExtLink(n)})}});break;case"#vwTechCmtHist":n("#lstTechCmtHist").kendoMobileListView({dataSource:i.ds.techCmtHist,template:"<div>#= CmtT #<\/div>"});break;case"#vwAdvSearch":i.set("advSearch",new h.AdvSearch);break;case"#vwEquips":l("Tap the equipment to select. Press and hold to select or de-select all.",c.SUCCESS);break;case"#vwTools":u=kendo.data.DataSource.create({schema:{model:h.Tool},data:i.ds.toollist.data(),group:"dummy",sort:{field:"Desc",dir:"asc"}});n("#toolSel").data("kendoMobileListView").setDataSource(u);l("Tap the tool name to select. Change quantity if needed.",c.SUCCESS);break;case"#vwLaborsD":case"#vwLaborsE":var nt=[],st=i.labor,tt=st.isD,ht="#lbrSel"+(tt?"D":"E");if(tt)u=kendo.data.DataSource.create({schema:{model:h.Labor},group:"dummy",sort:{field:"Date",dir:"asc"}});else{var nt=[],lt=i.setting.EmpNo,at=i.ds.techlist.data(),yt=kendo.data.Model.define({id:"No",fields:{No:{type:"number"},Name:{},ST:{type:"number",nullable:!0},OT:{type:"number",nullable:!0},my:{type:"boolean"}}});at.forEach(function(n){var t=n.No;nt.push({No:t,Name:n.Name,my:lt==t||et.indexOf(t)!=-1})});u=kendo.data.DataSource.create({schema:{model:yt},data:nt,group:"dummy",sort:[{field:"my",dir:"desc"},{field:"Name",dir:"asc"}]})}n(ht).data("kendoMobileListView").setDataSource(u);break;case"#vwImg":var it=n("#prev-img"),ut=n("#next-img"),ot=n("#srvImg").kendoMobileScrollView({dataSource:i.ds.curimgs,template:n("#tmImg").html(),change:function(n){var t=i.ds.curimgs.data().length;it.toggle(t>1&&n.page>0);ut.toggle(t>1&&n.page<t-1);i.img=n.data[0];a.cur.page=n.page;rt.setImgScrollerH(n.element.find(".ls-img-scroller"))}}).data("kendoMobileScrollView");it.click(function(){ot.prev()});ut.click(function(){ot.next()});n("#vwImg").on("change",".ls-img-desc",function(){i.ds.imgs.get(i.img.Ts).set("Desc",n(this).val())})}},vwShow:function(t){var s=t.view,st=s.element,y,d,w,p,b,g,tt,lt,ot,at,vt;if(st.find(".k-invalid-msg").hide(),st.find("textarea").height(10).data("autosize",!1).autosize(),y=window.location.hash,y){var pt=n(y=="/"?"#vwMain":y),ht=pt.attr("data-level"),wt=s.element.attr("data-level");ht>wt&&n.each(n("div[data-level="+ht+"]"),function(t,i){var u=n(i),r=u.data("kendoMobileView");r&&r.scroller&&r.scroller.reset()})}switch(s.id){case"/":case"#vwMain":i.wo=null;hr();break;case"#vwWo":var f=i.wo,ct=f.isNew(),bt=li(f);i.set("deletable",f.IsSelf&&(ct||!f.OnSche&&bt)&&f.IsActivated);i.set("lock.ohcd",!f.IsSelf||!ct||f.JobNo);kt();break;case"#vwWorkItem":si();break;case"#vwLaborItem":d=i.lock.dtl();p=function(n){var t=n.map(function(n){return n.getTime()});i.labor.isNew()&&t.indexOf(u.today().getTime())==-1&&i.set("labor.Date",n[0])};i.set("lock.lbrSel",d||!i.labor.isNew());si(p);w=n("#shift").mobiscroll("getInst");w.setValue(i.labor.Cat||" ",!0);d?w.disable():w.enable();break;case"#vwExpItem":si();break;case"#vwPdSum":p=function(t){var f=new kendo.data.DataSource({data:t,filter:{field:"PriEmpNo",operator:"neq",value:-1},group:{field:"Date",aggregates:[{field:"ST",aggregate:"sum"},{field:"OT",aggregate:"sum"},{field:"DT",aggregate:"sum"},{field:"TT",aggregate:"sum"}]}}),a=[],r={ST:0,OT:0,DT:0,Sum:0},o,s,h;f.fetch(function(){f.view().forEach(function(n){var i=n.aggregates,t={};t.ST=i.ST.sum+i.TT.sum;t.OT=i.OT.sum;t.DT=i.DT.sum;t.Sum=t.ST+t.OT+t.DT;r.ST+=t.ST;r.OT+=t.OT;r.DT+=t.DT;r.Sum+=t.Sum;a.push({Date:n.value,DayTot:t})})});o=new kendo.data.DataSource({data:a});t.forEach(function(n){o.filter({field:"Date",operator:"eq",value:n.Date});var t=o.view()[0];n.DayTot=t?t.DayTot:0});s=u.pd();h=n("#pdSumList").data("kendoMobileListView");n("#wkTot").html('{0}~{1} <span style="margin-left:2em">{2}<\/span>{3}'.formatWith(u.dui(s.uiFrom),u.dui(s.uiTo),it(r.Sum),sv.helper.renderTmpl(n("#tmHr"),{ST:it(r.ST),OT:it(r.OT),DT:it(r.DT)})));f=new kendo.data.DataSource({data:t,group:"Date",sort:[{field:"Date",dir:"asc"},{field:"JobCc",dir:"asc"},{field:"Cat",dir:"asc"}]});h?h.setDataSource(f):n("#pdSumList").kendoMobileListView({dataSource:f,headerTemplate:"#= sv.helper.pdSumListHeader(data) #",template:n("#tmPdSum").html(),click:function(n){e.from="#vwPdSum";ci(i.ds.wos.get(n.dataItem.WoTs))}});ft(f,{field:"PriEmpNo",operator:"eq",value:-1})&&l("Invalid ticket is not counted in total and will NOT be paid! Call office ASAP to correct!",c.FAIL)};o.wo.read.pdSum(i.setting.EmpNo,function(n){p(n);vi(!0)});break;case"#vwAdvSearch":b=s.element.find(".ls-mobi-date");b.mobiscroll("option","buttons",["set","clear","cancel"]);b.mobiscroll("option","minDate",null);b.mobiscroll("option","maxDate",new Date);break;case"#vwSetting":oi();break;case"#vwTools":g=function(n){n.isSel?(n.Qty||n.set("Qty",1),n.Days=1):(n.set("Qty",null),n.Days=null)};tt=kendo.data.DataSource.create({schema:{model:h.Tool}});nt.init("#toolSel",i.ds.tools,["Id"],tt,g);break;case"#vwLaborsD":case"#vwLaborsE":var r=i.labor,k=r.isD,ut="#lbrSel"+(k?"D":"E"),dt=function(n,t){t&&(n.Cat=r.Cat,k?(n.No=r.No,n.Name=r.Name):n.Date=r.Date)},g=function(n){n.isSel?(n.ST||n.set("ST",r.ST),n.OT||n.set("OT",r.OT),n.DT=r.DT,n.TT=r.TT):(n.set("ST",null),n.set("OT",null),n.DT=null,n.TT=null)},tt=kendo.data.DataSource.create({schema:{model:h.Labor}});k?(lt=hi().dates,ot=[],lt.forEach(function(n){ot.push({Date:n})}),n(ut).data("kendoMobileListView").dataSource.data(ot)):(at=n(ut),vt=at.data("kendoMobileListView").dataSource,vt.filter(et.length>0?{field:"my",operator:"eq",value:!0}:null));nt.init(ut,i.ds.labors,["Date","No","Cat"],tt,g,dt);k||et.length!=0||l("To speed up loading of this screen next time, press and hold the employee name to build up your group.",c.SUCCESS);break;case"#vwImg":a.cur.needSvr&&!yt(!0)&&l("You may not be able to view some or all images because there is no internet connection.",c.FAIL);a.cur.isAdd&&v("getImgSource",n("#btnImgAct"));rt.setImgScrollerH()}},vwInitModal:function(){ki(this.element.data("kendoMobileModalView").scroller)},tabSelect:function(n){document.activeElement.blur();var t=n.sender.currentItem().index();t!=0||s(i.ds.wos)||n.preventDefault()},chgSigMode:function(){var n=k.isDraw();if(n&&!w.view()){k.pad.init();return}k.setMode(n)},closeModalView:function(){n('div[data-role="modalview"]:visible').data("kendoMobileModalView").close()}},act:{copyTkt:function(n,t){var o=i.ds.wos,f,r;t=t||fr(n.target);o.query({filter:{field:"JobCc",operator:"eq",value:t},sort:{field:"Ts",dir:"desc"}});f=o.view()[0];r=i.ds.wos.add();r.Ts=u.nnow();r.RefEmpNo=i.setting.EmpNo;r.OhCd=f.OhCd;r.JobNo=f.JobNo;r.Cc=f.Cc;r.JobCc=gt(f.JobNo,f.Cc);r.CustName=f.CustName;r.Contact=f.Contact;r.Tel=f.Tel;r.CustPo=f.CustPo;r.Resp=f.Resp;r.RespTel=f.RespTel;r.Reason=pt(f.JobNo)?"":f.Reason;r.Addr=f.Addr;r.Equips=f.Equips;r.SigEmail=f.SigEmail;i.wo=r;s(i.ds.wos,"",function(){i.wo=null;e.vwMain();l("Ticket created. Verify Active ticket list.",c.SUCCESS)})},activate:function(){i.set("wo.IsActivated",!0);i.set("wo.IsSelf",!0);i.ds.wos.sync()},del:{wo:function(){st(i.ds.wos,i.wo,"",null,e.vwMain)},equip:function(){st(i.ds.equips,i.equip,"wo.Equips",s,e.vwWork)},work:function(){st(i.ds.works,i.work,"wo.Works",s,e.vwWork)},matl:function(){st(i.ds.matls,i.matl,"wo.Matls",s,e.vwMatl)},tool:function(){st(i.ds.tools,i.tool,"wo.Tools",s,e.vwMatl)},labor:function(){st(i.ds.labors,i.labor,"wo.Labors",s,e.vwLabor)},exp:function(){st(i.ds.exps,i.exp,"wo.Exps",s,e.vwExp)}},custAccept:function(){i.wo.Sig=ai();i.set("wo.SigDate",u.nnow());s(i.ds.wos,"",function(){ei(1);k.setMode();n("#btngSig").hide()})},closeTkt:{only:function(n,t){i.wo.IsPri?i.set("wo.IsCmp",!0):(i.set("wo.RefEmpNo",i.wo.PriEmpNo),i.set("wo.IsSelf",!1));s(i.ds.wos,"",function(){t?sv.act.copyTkt(null,i.wo.JobCc):e.vwMain()})},addNew:function(){sv.act.closeTkt.only(null,!0)},cmpWoConfirm:function(){v("closeTktConfirm",n("#btnCmpWo"))},cmpWo:function(){i.set("wo.IsCmp",!0);i.set("wo.IsCmpwo",!0);s(i.ds.wos,"",function(){o.wo.update.cmpWo(i.wo.JobNo,i.wo.Cc,function(){ct(i.viewCmp,!0,e.vwMain)})})}},jobNoHold:{unlock:function(){n.get(b+"/api/z/mobile/UnlockValidate",{ts:i.wo.Ts},function(n){l("Unlocking ticket "+(n?"is successful":"failed or not allowed"),n?c.SUCCESS:c.FAIL);n&&(ot.editDeadline=u.addHrs(1),i.set("wo.Unlock",!0))})},forcePushToServer:function(){i.wo.RevDate=u.nAdd(1,i.wo.RevDate);i.wo.forcePushToServer=!0;o.wo.update.multiple([i.wo],at)}},sigDiscard:function(){i.save.wo()},wohist:{viewDispatch:function(t){n.getJSON(b+"/api/z/mobile/viewdispatchimg",{refempno:i.setting.EmpNo,jobno:t.context.jobno,costcode:t.context.cc,wo:t.context.wo},function(n){sv.helper.clickExtLink(n)})},viewCmtT:function(t){n.getJSON(b+"/api/z/mobile/viewTechComment",{jobno:t.context.jobno,costcode:t.context.cc},function(n){i.ds.techCmtHist.data(n);f.navigate("#vwTechCmtHist")})}},multiSelAll:{sel:function(){nt.set(null,!0)},delSel:function(){nt.set(null,!1)}},multiSelLbrGrp:function(t){var i=t.context,o=i.No||t,u=!i.my,f=et.indexOf(i.No),e;if(u){if(f!=-1)return;et.push(o)}else{if(f==-1)return;et.splice(f,1)}r.myguys=JSON.stringify(et);i&&(i.set("my",u),e={No:i.No,Name:i.Name,my:u},n("#lbrSelE").data("kendoMobileListView").dataSource.pushUpdate(e))},srvImg:{addConfirm:function(){a.cur.pickSourceType(!0)},replaceConfirm:function(){a.cur.pickSourceType(!1)},delImgConfirm:function(){v("delImgConfirm",n("#btnImgAct"))},camera:function(){a.capture(!0)},gallery:function(){a.capture(!1)},del:function(){var u=i.ds.curimgs,t=i.ds.imgs,f=i.img,o=tt(u,{field:"No",operator:"gt",value:f.No});o.forEach(function(n){n.No--;var i=tt(t,{field:"Ts",operator:"eq",value:n.Ts});i[0].No=n.No});var h=u.data().length-1,r=a.cur.page,e=n("#srvImg").data("kendoMobileScrollView");t.remove(t.get(f.Ts));s(t,"wo.Imgs");u.remove(f);r>0&&e.scrollTo(r==h?r-1:r);e.refresh()}}},helper:{isPhoneGap:y,fDate:u,getTechName:wt,tktDate:function(n){if(!n)return"0/0";var t=u.dui(u.nd(n));return t.substr(0,t.length-5)},renderTmpl:function(n,t){return kendo.Template.compile(n.html())(t)},toTop:function(n){var i,r,u,t;if(n&&(i=n.button.closest("div[data-role=modalview]"),i.length)){i.data("kendoMobileModalView").scroller.reset();return}r=f.view().element.find("ul[data-role=listview]");r&&(u=r.data("kendoMobileListView"),t=u._itemBinder,t.buffer&&(t.buffer.range(0),t.list.refresh()));f.view().scroller.reset()},woListHeader:function(n){var t=n.items[0],i='<div class="ls-sts {0}"><\/div>'.formatWith(bi(t));return('<div data-key="{0}" data-role="touch" data-hold="sv.helper.woListHeaderHold" class="ls-group-title">'+i+"<span>{0} <\/span>"+(t.PriEmpNo!=-1?"":'<span class="ls-alert">(INVALID) <\/span>')+'<span class="ls-font-normal">{1}<\/span><\/div>').formatWith(t.JobCc,t.CustName)},woListHeaderHold:function(n){v("copyTkt",n.touch.target)},jobNoHold:function(n){v("jobNoHold",n.touch.target)},pdSumListHeader:function(t){var i=t.items[0];return'<div class="ls-group-title">{0}<span style="margin-left:2em">{1}<\/span>{2}<\/div>'.formatWith(u.dui2(t.value),it(i.DayTot.Sum),sv.helper.renderTmpl(n("#tmHr"),{ST:it(i.DayTot.ST),OT:it(i.DayTot.OT),DT:it(i.DayTot.DT)}))},clickExtLink:function(n){y?window.open(n,"_system"):window.open(n,"_blank")},appUpdate:function(){if(event.preventDefault(),n("#msgblk").slideUp(1e3),g.ios){var t=window.open(b+"/s/mobile/appios?refempno={0}&ssn4={1}".formatWith(r.EmpNo,r.Ssn4),"_blank","hidden=yes");t.addEventListener("exit",function(){alert('Press "Home" button to view the installation progress.')});setTimeout(function(){t.close()},3e3)}else g.android&&n.ajax({url:b+"/api/z/mobile/appandroid",data:{refempno:r.EmpNo,ssn4:r.Ssn4},success:function(n){var t=function(n){f.hideLoading();l(n,c.FAIL)},i=new FileTransfer;fi("Downloading...");i.download(n,cordova.file.externalCacheDirectory+"Mobile.apk",function(n){f.hideLoading();window.plugins.webintent.startActivity({action:window.plugins.webintent.ACTION_VIEW,url:n.toURL(),type:"application/vnd.android.package-archive"},function(){},function(){t("Error launching app update")})},function(n){t("Error downloading app: error code "+n.code)},!0)},complete:null})},pushNotification:{android:function(n){switch(n.event){case"registered":n.regid.length>0&&er(n.regid);break;case"message":alert(n.message);break;case"error":l("GCM error = "+n.msg,c.FAIL);break;default:l("An unknown GCM event has occurred",c.FAIL)}},ios:function(n){n.alert&&navigator.notification.alert(n.alert);n.badge&&pushNotification.setApplicationIconBadgeNumber(null,null,n.badge)}},shiftDesc:function(n){return n?'(<span class="ls-alert">'+n+(n=="2"?"nd":"rd")+" Shift<\/span>)":""}}}}(jQuery);String.prototype.formatWith=function(){for(var i,t=this,n=0;n<arguments.length;n++)i=new RegExp("\\{"+n+"\\}","gi"),t=t.replace(i,arguments[n]);return t};$(function(){var n=sv.helper.isPhoneGap;n?document.addEventListener("deviceready",function(){navigator.splashscreen.hide();sv.init()}):sv.init()});
//# sourceMappingURL=app.min.js.map
